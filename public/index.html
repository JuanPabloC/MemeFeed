<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeFeed</title>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="authenticate.js"></script>
    <script type="text/javascript" src="makenavbar.js"></script>
    <script>
        var socket = io();
        var x = 0;
        var lastCalled = new Date().getTime();

        window.onload = function() {
            navbar();
            bottomPage();
        }

        window.onscroll = function() {
            if (document.documentElement.scrollHeight - document.documentElement.scrollTop < 2000) {
                console.log("Loading more...");
                var currentTime = new Date().getTime();
                if (currentTime - lastCalled > 5000) {
                    var content = document.getElementById("content");
                    for (var i = 0; i < content.children.length; i++) {
                        content.children[i].remove();
                    }
                    bottomPage();
                }
            }
        }

        socket.on('newContent', function(content) {
            for (var i = 0; i < content.length; i++) {
                var info = document.createElement("div");
                info.className = "story";

                if (content[i].src == "reddit") {
                    var title = '<h3><a href="'+content[i].link+'">'+content[i].title+'</a></h3>';
                    var author = '<span>Author: '+content[i].user+'</span>';
                    var score = '<span>Score: '+content[i].score+'</span>';
                    info.innerHTML = title+'<br>'+author+'<br>'+score;
                } else if (content[i].src == "youtube") {
                    var title = '<h3>'+content[i].title+'</h3>';
                    var vidLink = content[i].link.replace("watch?v=", "embed/");
                    var video = document.createElement('iframe');
                    video.width = "560";
                    video.height = "315";
                    video.src = "https://youtube.com" + vidLink + "?autoplay=1&loop=1&mute=1";
                    video.frameborder = "0";
                    info.innerHTML = title;
                    info.appendChild(video);
                } else if (content[i].src == "memecenter") {
                    info.innerHTML = '<a href="'+content[i].link+'">'+content[i].meme+'</a>';
                }

                var save = document.createElement("button");
                save.innerHTML = "Save";
                save.onclick = function() {
                    if (localStorage.loggedIn == "false") {
                        alert("You must login to save content!");
                        return false;
                    }
                    var sendMe = {};
                    sendMe['userId'] = Number(localStorage.userId);
                    sendMe['content'] = escape(this.parentElement.outerHTML);

                    var sendme = JSON.stringify(sendMe);

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", '/savecontent', true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhr.onreadystatechange = function() {
                        if(xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
                            var response = xhr.responseText;
                            if (response == "success") {
                                alert("Saved!");
                            } else {
                                alert("Please try saving again.");
                            }
                            
                        }
                    }
                    xhr.send(sendme);
                };

                var share = document.createElement("button");
                share.innerHTML = "Share";
                share.onclick = function() {

                }

                info.appendChild(save);
                info.appendChild(share);

                document.getElementById("content").appendChild(info);
            }
        });

        function bottomPage() {
            lastCalled = new Date().getTime();
            console.log("YEKJ");
            socket.emit('loadMore', x);
            x++;
        }

    </script>

    <style>
        #content {
            margin-left:25%;
            margin-right:25%;
        }
        .story {
            padding: 0px;
            margin-left:0px;
            margin-bottom:10px;
            border:2px solid black;
        }
        #nav {
            position:fixed;
        }
    </style>

</head>
<body>
    <div id="nav"></div>
    <div id="content"></div>
    <center>Loading...</center>
    
</body>
</html>
